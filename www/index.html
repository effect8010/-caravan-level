<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Caravan Level Meter</title>
   <link rel="manifest" href="manifest.json">
   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="black">
   <meta name="apple-mobile-web-app-title" content="Level Meter">
   <link rel="icon" href="icon.png">
   <style>
       /* 이전 스타일 코드 유지 */
       .audio-control {
           position: fixed;
           top: 10px;
           right: 10px;
           background: #333;
           padding: 10px;
           border-radius: 5px;
           display: flex;
           align-items: center;
           gap: 10px;
       }
       .audio-control label {
           color: #fff;
           font-size: 14px;
       }
   </style>
</head>
<body>
   <!-- 오디오 컨트롤 추가 -->
   <div class="audio-control">
       <input type="checkbox" id="soundToggle" checked>
       <label for="soundToggle">알림음</label>
   </div>

   <!-- 기존 HTML 구조 유지 -->
   <div class="container">
       <!-- 이전 컨텐츠 유지 -->
   </div>

   <!-- 알림음 요소 추가 -->
   <audio id="alertSound" preload="auto">
       <source src="data:audio/mpeg;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAAKAAAIkAAjIyMjIyMjIyMjQ0NDQ0NDQ0NDY2NjY2NjY2NjY4CAgICAgICAgICcnJycnJycnJy4uLi4uLi4uLi4zMzMzMzMzMzMzT09PT09PT09PT4+Pj4+Pj4+Pj4+/v7+/v7+/v7+/////////////////////////////////8AAAA5TEFNRTMuMTAwBEgAAAAAAAAAABUgJAMGQQABmgAABJAYz+KhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//sQxAADwAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAARMQU1FMy4xMDBVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" type="audio/mpeg">
   </audio>

   <script>
       // 기존 상수 선언
       const CARAVAN_LENGTH = 7484;
       const CARAVAN_WIDTH = 2299;
       const MAX_ANGLE = 10;

       // DOM 요소
       const mainBubble = document.getElementById('mainBubble');
       const verticalBubble = document.getElementById('verticalBubble');
       const horizontalBubble = document.getElementById('horizontalBubble');
       const alertSound = document.getElementById('alertSound');
       const soundToggle = document.getElementById('soundToggle');

       // 알림음 상태 관리
       let isPlaying = false;
       let lastAlertTime = 0;
       const ALERT_COOLDOWN = 2000; // 알림음 간격 (2초)

       function playAlertIfNeeded(heights) {
           if (!soundToggle.checked) return;

           const maxHeight = Math.max(
               Math.abs(heights.frontLeft),
               Math.abs(heights.frontRight),
               Math.abs(heights.rearLeft),
               Math.abs(heights.rearRight)
           );

           // 10cm 이하일 때 알림음 재생
           if (maxHeight <= 10) {
               if (!isPlaying) {
                   alertSound.loop = true; // 반복 재생 설정
                   alertSound.play();
                   isPlaying = true;
               }
           } else {
               // 10cm 초과 시 알림음 정지
               if (isPlaying) {
                   alertSound.pause();
                   alertSound.currentTime = 0;
                   isPlaying = false;
               }
           }
       }

       // 기존 함수들...
       function calculateHeights(beta, gamma) {
           const fbRadians = beta * (Math.PI / 180);
           const lrRadians = gamma * (Math.PI / 180);
           
           const fbHeightDiff = Math.sin(fbRadians) * (CARAVAN_LENGTH / 2) / 10;
           const lrHeightDiff = Math.sin(lrRadians) * (CARAVAN_WIDTH / 2) / 10;

           const leftHeight = gamma > 0 ? Math.abs(lrHeightDiff) : 0;
           const rightHeight = gamma < 0 ? Math.abs(lrHeightDiff) : 0;

           return {
               frontLeft: beta < 0 ? (Math.abs(fbHeightDiff) + leftHeight) : leftHeight,
               frontRight: beta < 0 ? (Math.abs(fbHeightDiff) + rightHeight) : rightHeight,
               rearLeft: beta > 0 ? (Math.abs(fbHeightDiff) + leftHeight) : leftHeight,
               rearRight: beta > 0 ? (Math.abs(fbHeightDiff) + rightHeight) : rightHeight
           };
       }

       function limitAngle(angle) {
           return Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, angle));
       }

       function updateBubbles(beta, gamma) {
           const limitedBeta = limitAngle(beta);
           const limitedGamma = limitAngle(gamma);

           const circularMaxMove = 60;
           const barMaxMove = 50;

           const x = (-limitedGamma / MAX_ANGLE) * circularMaxMove;
           const y = (-limitedBeta / MAX_ANGLE) * circularMaxMove;
           mainBubble.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

           const verticalMove = (-limitedBeta / MAX_ANGLE) * barMaxMove;
           verticalBubble.style.transform = `translate(-50%, calc(-50% + ${verticalMove}px))`;

           const horizontalMove = (-limitedGamma / MAX_ANGLE) * barMaxMove;
           horizontalBubble.style.transform = `translate(calc(-50% + ${horizontalMove}px), -50%)`;
       }

       function updateOutriggerValues(heights) {
           Object.entries(heights).forEach(([position, height]) => {
               const element = document.getElementById(position);
               const absHeight = Math.abs(height).toFixed(1);
               let className = 'outrigger-value ';
               
               if (absHeight < 1) {
                   className += 'level-green';
               } else if (absHeight < 3) {
                   className += 'level-yellow';
               } else {
                   className += 'level-red';
               }
               
               element.textContent = `${absHeight}cm`;
               element.className = className;
           });

           // 알림음 재생 확인
           playAlertIfNeeded(heights);
       }

       function handleOrientation(event) {
           const beta = event.beta;
           const gamma = event.gamma;

           updateBubbles(beta, gamma);
           updateOutriggerValues(calculateHeights(beta, gamma));
       }

       // 센서와 오디오 권한 요청
       async function requestPermissions() {
           try {
               // 센서 권한 요청
               if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                   const sensorPermission = await DeviceOrientationEvent.requestPermission();
                   if (sensorPermission === 'granted') {
                       window.addEventListener('deviceorientation', handleOrientation);
                   }
               } else {
                   window.addEventListener('deviceorientation', handleOrientation);
               }

               // 오디오 컨텍스트 초기화 (자동 재생 정책 우회)
               const audioContext = new (window.AudioContext || window.webkitAudioContext)();
               if (audioContext.state === 'suspended') {
                   await audioContext.resume();
               }
           } catch (error) {
               console.error('권한 요청 실패:', error);
           }
       }

       // 페이지 로드 시 권한 요청
       document.addEventListener('DOMContentLoaded', requestPermissions);

       // 사용자 상호작용으로 인한 권한 요청 (iOS Safari를 위한 대비책)
       document.body.addEventListener('click', requestPermissions, { once: true });
   </script>
</body>
</html>