<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Caravan Level Meter</title>
   <style>
       body {
           margin: 0;
           padding: 10px;
           font-family: Arial, sans-serif;
           background-color: #000;
           color: #fff;
       }
       .container {
           max-width: 100%;
           margin: 0 auto;
           padding: 10px;
       }
       .level-meters {
           display: flex;
           flex-direction: column;
           gap: 10px;
           align-items: center;
       }
       .meters-group {
           display: flex;
           gap: 10px;
           align-items: center;
       }
       .circular-level {
           width: 150px;
           height: 150px;
           border-radius: 50%;
           border: 3px solid #333;
           background-color: #1a1a1a;
           position: relative;
           overflow: hidden;
       }
       .circular-bubble {
           width: 30px;
           height: 30px;
           background: #90EE90;
           border-radius: 50%;
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           transition: all 0.1s ease;
       }
       .crosshair {
           position: absolute;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
       }
       .crosshair::before, .crosshair::after {
           content: '';
           position: absolute;
           background: #333;
       }
       .crosshair::before {
           left: 0;
           right: 0;
           height: 1px;
           top: 50%;
       }
       .crosshair::after {
           top: 0;
           bottom: 0;
           width: 1px;
           left: 50%;
       }
       .bar-level {
           background-color: #1a1a1a;
           border: 3px solid #333;
           position: relative;
           overflow: hidden;
       }
       .bar-level.vertical {
           width: 40px;
           height: 150px;
       }
       .bar-level.horizontal {
           width: 150px;
           height: 40px;
           margin-top: 10px;
       }
       .bar-bubble {
           width: 30px;
           height: 30px;
           background: #90EE90;
           border-radius: 50%;
           position: absolute;
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           transition: all 0.1s ease;
       }
       .outriggers {
           display: grid;
           grid-template-columns: repeat(2, 1fr);
           gap: 20px;
           margin-top: 30px;
           background: #1a1a1a;
           padding: 20px;
           border-radius: 10px;
       }
       .outrigger {
           text-align: center;
           padding: 15px;
           border: 1px solid #333;
           border-radius: 5px;
       }
       .outrigger-value {
           font-size: 24px;
           font-weight: bold;
           margin-top: 10px;
       }
       .level-green { color: #90EE90; }
       .level-yellow { color: #FFD700; }
       .level-red { color: #FF4444; }
   </style>
</head>
<body>
   <div class="container">
       <div class="level-meters">
           <div class="meters-group">
               <div class="bar-level vertical">
                   <div class="bar-bubble" id="verticalBubble"></div>
               </div>
               
               <div class="circular-level">
                   <div class="crosshair"></div>
                   <div class="circular-bubble" id="mainBubble"></div>
               </div>
           </div>
           
           <div class="bar-level horizontal">
               <div class="bar-bubble" id="horizontalBubble"></div>
           </div>
       </div>

       <div class="outriggers">
           <div class="outrigger">
               <div>전방 좌측</div>
               <div class="outrigger-value" id="frontLeft">0.0cm</div>
           </div>
           <div class="outrigger">
               <div>전방 우측</div>
               <div class="outrigger-value" id="frontRight">0.0cm</div>
           </div>
           <div class="outrigger">
               <div>후방 좌측</div>
               <div class="outrigger-value" id="rearLeft">0.0cm</div>
           </div>
           <div class="outrigger">
               <div>후방 우측</div>
               <div class="outrigger-value" id="rearRight">0.0cm</div>
           </div>
       </div>
   </div>

   <script>
       const CARAVAN_LENGTH = 7484;
       const CARAVAN_WIDTH = 2299;
       const MAX_ANGLE = 10;

       const mainBubble = document.getElementById('mainBubble');
       const verticalBubble = document.getElementById('verticalBubble');
       const horizontalBubble = document.getElementById('horizontalBubble');

       // Capacitor 모션 센서 초기화
       document.addEventListener('DOMContentLoaded', async () => {
           try {
               const { Motion } = await import('@capacitor/motion');
               
               // 센서 권한 요청
               await Motion.requestPermissions();
               
               // 방향 센서 리스너 등록
               await Motion.addListener('orientation', (event) => {
                   const { beta, gamma } = event;
                   updateBubbles(beta, gamma);
                   updateOutriggerValues(calculateHeights(beta, gamma));
               });
           } catch (error) {
               console.error('센서 초기화 실패:', error);
           }
       });

       function calculateHeights(beta, gamma) {
           const fbRadians = beta * (Math.PI / 180);
           const lrRadians = gamma * (Math.PI / 180);
           
           const fbHeightDiff = Math.sin(fbRadians) * (CARAVAN_LENGTH / 2) / 10;
           const lrHeightDiff = Math.sin(lrRadians) * (CARAVAN_WIDTH / 2) / 10;

           const leftHeight = gamma > 0 ? Math.abs(lrHeightDiff) : 0;
           const rightHeight = gamma < 0 ? Math.abs(lrHeightDiff) : 0;

           return {
               frontLeft: beta < 0 ? (Math.abs(fbHeightDiff) + leftHeight) : leftHeight,
               frontRight: beta < 0 ? (Math.abs(fbHeightDiff) + rightHeight) : rightHeight,
               rearLeft: beta > 0 ? (Math.abs(fbHeightDiff) + leftHeight) : leftHeight,
               rearRight: beta > 0 ? (Math.abs(fbHeightDiff) + rightHeight) : rightHeight
           };
       }

       function limitAngle(angle) {
           return Math.max(-MAX_ANGLE, Math.min(MAX_ANGLE, angle));
       }

       function updateBubbles(beta, gamma) {
           const limitedBeta = limitAngle(beta);
           const limitedGamma = limitAngle(gamma);

           const circularMaxMove = 60;
           const barMaxMove = 50;

           const x = (-limitedGamma / MAX_ANGLE) * circularMaxMove;
           const y = (-limitedBeta / MAX_ANGLE) * circularMaxMove;
           mainBubble.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

           const verticalMove = (-limitedBeta / MAX_ANGLE) * barMaxMove;
           verticalBubble.style.transform = `translate(-50%, calc(-50% + ${verticalMove}px))`;

           const horizontalMove = (-limitedGamma / MAX_ANGLE) * barMaxMove;
           horizontalBubble.style.transform = `translate(calc(-50% + ${horizontalMove}px), -50%)`;
       }

       function updateOutriggerValues(heights) {
           Object.entries(heights).forEach(([position, height]) => {
               const element = document.getElementById(position);
               const absHeight = Math.abs(height).toFixed(1);
               let className = 'outrigger-value ';
               
               if (absHeight < 1) {
                   className += 'level-green';
               } else if (absHeight < 3) {
                   className += 'level-yellow';
               } else {
                   className += 'level-red';
               }
               
               element.textContent = `${absHeight}cm`;
               element.className = className;
           });
       }
   </script>
</body>
</html>