<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caravan Level Meter</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Level Meter">
    <link rel="icon" href="icon.png">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .level-container {
            background-color: #222;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .bubble-level {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            border: 3px solid #444;
            border-radius: 50%;
            position: relative;
            background-color: #111;
        }
        .bubble {
            width: 30px;
            height: 30px;
            background: #90EE90;
            border-radius: 50%;
            position: absolute;
            box-shadow: 0 0 10px #90EE90;
            transition: all 0.1s ease;
        }
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 280px;
            height: 280px;
            transform: translate(-50%, -50%);
            border: 2px solid #444;
            border-radius: 50%;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: #444;
        }
        .crosshair::before {
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            transform: translateY(-50%);
        }
        .crosshair::after {
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            transform: translateX(-50%);
        }
        .bar-level {
            width: 300px;
            height: 60px;
            margin: 20px auto;
            background-color: #111;
            border: 3px solid #444;
            position: relative;
            border-radius: 5px;
        }
        .bar-bubble {
            width: 20px;
            height: 40px;
            background: #90EE90;
            position: absolute;
            top: 10px;
            box-shadow: 0 0 10px #90EE90;
            transition: all 0.1s ease;
        }
        .angle-display {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            font-family: monospace;
        }
        .caravan-display {
            margin-top: 40px;
            padding: 20px;
            background-color: #222;
            border-radius: 10px;
        }
        .corner-value {
            font-size: 18px;
            padding: 10px;
            background-color: #333;
            border-radius: 5px;
            margin: 5px;
            display: inline-block;
        }
        .green-text { color: #90EE90; }
        .yellow-text { color: #FFD700; }
        .red-text { color: #FF6B6B; }
    </style>
</head>
<body>
    <div class="container">
        <div class="level-container">
            <div class="bubble-level">
                <div class="crosshair"></div>
                <div class="bubble" id="mainBubble"></div>
            </div>
            <div class="bar-level">
                <div class="bar-bubble" id="xBubble"></div>
            </div>
            <div class="bar-level">
                <div class="bar-bubble" id="yBubble"></div>
            </div>
            <div class="angle-display">
                X: <span id="xAngle">0.0</span>° | Y: <span id="yAngle">0.0</span>°
            </div>
        </div>
        
        <div class="caravan-display">
            <h3>아웃트리거 조정값 (mm)</h3>
            <div style="text-align: center;">
                <div class="corner-value" id="fl">전방 좌측: 0</div>
                <div class="corner-value" id="fr">전방 우측: 0</div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <div class="corner-value" id="bl">후방 좌측: 0</div>
                <div class="corner-value" id="br">후방 우측: 0</div>
            </div>
        </div>
    </div>

    <script>
        // 카라반 치수
        const CARAVAN_LENGTH = 7484; // mm (전체 길이)
        const CARAVAN_WIDTH = 2299;  // mm (전체 폭)

        const mainBubble = document.getElementById('mainBubble');
        const xBubble = document.getElementById('xBubble');
        const yBubble = document.getElementById('yBubble');
        const xAngleDisplay = document.getElementById('xAngle');
        const yAngleDisplay = document.getElementById('yAngle');

        function calculateCornerHeights(fbAngle, lrAngle) {
            const fbRadians = fbAngle * (Math.PI / 180);
            const lrRadians = lrAngle * (Math.PI / 180);
            
            const fbHeightDiff = Math.sin(fbRadians) * (CARAVAN_LENGTH / 2);
            const lrHeightDiff = Math.sin(lrRadians) * (CARAVAN_WIDTH / 2);

            return {
                fl: Math.round((-fbHeightDiff - lrHeightDiff)),
                fr: Math.round((-fbHeightDiff + lrHeightDiff)),
                bl: Math.round((fbHeightDiff - lrHeightDiff)),
                br: Math.round((fbHeightDiff + lrHeightDiff))
            };
        }

        function updateBubblePositions(x, y) {
            // 원형 수평계 업데이트
            const maxRadius = 135; // 버블의 최대 이동 반경
            const xPos = (y * maxRadius / 90);
            const yPos = (x * maxRadius / 90);
            mainBubble.style.transform = `translate(${xPos}px, ${yPos}px)`;

            // 바 수평계 업데이트
            const barMaxMove = 140;
            xBubble.style.left = `${150 + (y * barMaxMove / 90)}px`;
            yBubble.style.left = `${150 + (x * barMaxMove / 90)}px`;
        }

        function updateCornerValues(heights) {
            Object.entries(heights).forEach(([corner, height]) => {
                const element = document.getElementById(corner);
                if (element) {
                    let className = 'corner-value ';
                    const absHeight = Math.abs(height);
                    if (absHeight < 10) {
                        className += 'green-text';
                    } else if (absHeight < 30) {
                        className += 'yellow-text';
                    } else {
                        className += 'red-text';
                    }
                    element.className = className;
                    element.textContent = `${corner.toUpperCase()}: ${absHeight}mm`;
                }
            });
        }

        function handleOrientation(event) {
            const x = event.beta;  // 전후 기울기
            const y = event.gamma; // 좌우 기울기

            const fbTilt = Math.max(-90, Math.min(90, x));
            const lrTilt = Math.max(-90, Math.min(90, y));

            xAngleDisplay.textContent = fbTilt.toFixed(1);
            yAngleDisplay.textContent = lrTilt.toFixed(1);

            updateBubblePositions(fbTilt, lrTilt);
            updateCornerValues(calculateCornerHeights(fbTilt, lrTilt));
        }

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation);
                    }
                })
                .catch(console.error);
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }
    </script>
</body>
</html>